<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: "Tajawal", sans-serif;
    }

    .sidebar:hover {
      width: 220px;
    }

    .sidebar:hover .link-text {
      display: inline;
    }

    .input-style {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
    }

    /** Tailwind Custom Animation -->**/
    @keyframes spin-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin-slow {
      animation: spin-slow 2s linear infinite;
    }

    .animate-fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <aside
      class="sidebar bg-gradient-to-b from-gray-900 to-gray-800 text-white w-16 hover:w-56 transition-all duration-300 overflow-hidden shadow-lg">
      <div class="flex flex-col h-full p-2 space-y-6 pt-6">
        <div class="flex items-center space-x-2 px-4 mb-4">
          <i data-lucide="layout-dashboard" class="w-6 h-6 text-blue-400"></i>
          <span class="link-text hidden font-semibold text-lg">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        </div>
        <button onclick="loadContent('home')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-gray-800 transition text-right">
          <i data-lucide="home" class="w-7 h-7 text-yellow-400"></i>
          <span class="link-text hidden">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button onclick="loadContent('attendance')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-blue-800 transition text-right">
          <i data-lucide="clock-9" class="w-7 h-7 text-blue-300"></i>
          <span class="link-text hidden">Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</span>
        </button>
        <button onclick="loadContent('housing')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-green-800 transition text-right">
          <i data-lucide="cable" class="w-7 h-7 text-green-300"></i>
          <span class="link-text hidden">Ø§Ù„ØªØ³ÙƒÙŠÙ†</span>
        </button>
        <button onclick="loadContent('repayment')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-purple-800 transition text-right">
          <i data-lucide="circle-dollar-sign" class="w-7 h-7 text-purple-300"></i>
          <span class="link-text hidden">Repayment</span>
        </button>
        <button onclick="loadContent('addEmployee')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-orange-900 transition text-right">
          <i data-lucide="user-plus" class="w-7 h-7 text-orange-400"></i>
          <span class="link-text hidden">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</span>
        </button>
        <button onclick="loadContent('viewEmployees')"
          class="flex items-center space-x-2 px-4 py-3 rounded hover:bg-teal-700 transition text-right">
          <i data-lucide="users" class="w-7 h-7 text-teal-400"></i>
          <span class="link-text hidden">Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
        </button>
      </div>
    </aside>
    <!-- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="flex-1 p-4 md:p-8 bg-white rounded-none md:rounded-l-3xl shadow-inner overflow-y-auto max-h-screen">
      <div id="mainContent">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ</h1>
        <p class="text-gray-600">
          Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©.
        </p>
      </div>
    </main>
  </div>
  <!-- Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ø²Ø¬Ø§Ø¬ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
  <div id="loaderOverlay"
    class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-md flex justify-center items-center z-50 hidden">
    <div
      class="bg-white dark:bg-gray-900 bg-opacity-70 dark:bg-opacity-80 px-8 py-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col items-center space-y-4 animate-fade-in">
      <!-- Animation -->
      <div class="relative w-16 h-16">
        <div class="absolute inset-0 border-4 border-blue-500 border-dashed rounded-full animate-spin-slow"></div>
        <div class="absolute inset-2 bg-blue-500 rounded-full shadow-inner animate-ping"></div>
      </div>
      <!-- Text -->
      <p class="text-lg font-semibold text-gray-800 dark:text-gray-200">
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      </p>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù†ØªØ¸Ø±
        <span id="countdown" class="text-blue-600 font-bold">0</span> Ø«Ø§Ù†ÙŠØ©...
      </p>
    </div>
  </div>
  <div id="statsPopup"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative animate-fade-in">
      <h2 class="text-xl font-bold text-center text-indigo-800 mb-4">
        ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      </h2>

      <div id="statsContent" class="space-y-4 text-center text-gray-800">
        <p>
          <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</strong> <span id="totalCount">--</span>
        </p>
        <p>
          <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ²ÙˆØ¬ÙŠÙ†:</strong> <span id="marriedCount">--</span>
        </p>
        <p>
          <strong>Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø±ØªØ¨:</strong> <span id="avgSalary">--</span> Ø¬Ù†ÙŠÙ‡
        </p>

        <canvas id="statsChart" class="mx-auto" width="200" height="200"></canvas>
      </div>

      <div class="flex justify-between mt-6">
        <button onclick="downloadStatsPDF()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF
        </button>
        <button onclick="hideStatsPopup()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
          âŒ Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <div id="housingStatsPopup"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center z-50 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl relative animate-fade-in">
      <h2 class="text-xl font-bold text-center text-indigo-800 mb-4">
        ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ³ÙƒÙŠÙ†
      </h2>

      <div id="housingStatsContent" class="space-y-6 text-center text-gray-800">
        <canvas id="officeChart" height="70"></canvas>
        <canvas id="hondaChart" height="70"></canvas>
        <div class="text-sm text-gray-600">
          <p>
            <strong>Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§:</strong>
            <span id="totalHondaHours">--</span> Ø³Ø§Ø¹Ø©
          </p>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button onclick="downloadHousingStatsPDF()"
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF
        </button>
        <button onclick="hideHousingStats()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
          âŒ Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØµÙØ­Ø© -->
  <script>
    lucide.createIcons();
    let lastDataTime = null;
    function loadContent(section) {
      const main = document.getElementById("mainContent");
      if (section === "attendance") {
        main.innerHTML = `
      <h2 class="text-2xl font-bold text-blue-800 mb-4">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h2>
      <div class="flex flex-wrap gap-4 items-center bg-blue-50 p-4 rounded shadow mb-4">
        <input type="text" id="searchName" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
        <div class="flex items-center gap-2">
          <label for="fromDate" class="text-sm text-gray-700">Ù…Ù†:</label>
          <input type="date" id="fromDate" class="px-2 py-1 border rounded" onchange="filterTable()" />
        </div>
        <div class="flex items-center gap-2">
          <label for="toDate" class="text-sm text-gray-700">Ø¥Ù„Ù‰:</label>
          <input type="date" id="toDate" class="px-2 py-1 border rounded" onchange="filterTable()" />
        </div>
        <button onclick="fetchNewAttendance()" class="ml-auto bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 flex items-center gap-2">
          <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-300 rounded shadow">
          <thead class="bg-blue-200 text-blue-900">
            <tr>
              <th class="px-4 py-2 border">Ø§Ù„ÙˆÙ‚Øª</th>
              <th class="px-4 py-2 border">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="px-4 py-2 border">Ø§Ù„Ù…ÙƒØªØ¨</th>
              <th class="px-4 py-2 border">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
              <th class="px-4 py-2 border">Latitude</th>
              <th class="px-4 py-2 border">Longitude</th>
              <th class="px-4 py-2 border">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody"></tbody>
        </table>
      </div>
    `;
        lucide.createIcons();
        fetchNewAttendance();
      } else if (section === "housing") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-green-800 mb-4">ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³ÙƒÙŠÙ†</h2>
    <div class="flex flex-wrap gap-4 items-center bg-blue-50 p-4 rounded shadow mb-4">
        <input type="text" id="searchName" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
  <input type="text" id="searchSiteID" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹..." class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" oninput="filterTable()" />
        <button onclick="fetchHousingData()" class="ml-auto bg-blue-700 text-white px-4 py-2 rounded shadow hover:bg-blue-800 flex items-center gap-2">
         <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
          <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </button>
        <button onclick="showHousingStats()"
        class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2">
  <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
  <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
</button>

      </div>
    <div class="overflow-auto rounded shadow border border-gray-300">
      <table class="min-w-full bg-white text-center border border-gray-200">
        <thead id="housingTableHead" class="bg-green-100 text-green-800 font-bold">
          <tr>
              <th class="px-4 py-2 border">Ø§Ù„ÙˆÙ‚Øª Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th class="px-4 py-2 border">Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ†</th>
              <th class="px-4 py-2 border">Ø£Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
              <th class="px-4 py-2 border">Ø§Ù„Ù…ÙƒØªØ¨</th>
              <th class="px-4 py-2 border">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§</th>
              <th class="px-4 py-2 border">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
              <th class="px-4 py-2 border">Ø³Ø¨Ø¨ Ø§Ù„ØªØ³ÙƒÙŠÙ†</th>
              <th class="px-4 py-2 border">ØªØ±Ø§Ù†Ø³Ù…ÙŠØ´Ù†Â ÙÙ‚Ø· </th>
            </tr>
          </thead>
        <tbody id="housingTableBody"></tbody>
      </table>
    </div>
  `;
        lucide.createIcons();
        fetchHousingData();
      } else if (section === "repayment") {
        main.innerHTML = `
      <h2 class="text-2xl font-bold text-purple-800 mb-2">ğŸ“¸ ØµÙØ­Ø© Repayment</h2>
      <p class="text-gray-700">Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ± ÙˆØ±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§.</p>
    `;
      } else if (section === "home") {
        main.innerHTML = `
    <section class="space-y-8">
      <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center mt-6">
        <div class="bg-white p-4 rounded-xl shadow border text-teal-700">
          <div class="text-3xl font-bold" id="employeeCount">--</div>
          <div class="mt-2">ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow border text-orange-700 text-right">
  <div class="text-lg font-bold mb-2">ğŸ¢ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØ§ØªØ¨</div>
  <ul id="officeList" class="space-y-1 text-sm">
    <!-- Ù‡Ù†Ù…Ù„Ø£Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
  </ul>
</div>

        <div class="bg-white p-4 rounded-xl shadow border text-indigo-700">
          <div class="text-3xl font-bold" id="housingCount">--</div>
          <div class="mt-2">ğŸ  Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ³ÙƒÙŠÙ† Ø§Ù„Ù†Ø´Ø·Ø©</div>
        </div>
        <div class="bg-white p-4 rounded-xl shadow border text-gray-700">
          <div class="text-xl font-semibold" id="lastUpdate">--</div>
          <div class="mt-2">ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
        <div class="bg-white p-4 rounded-xl shadow border">
          <h3 class="font-bold text-teal-700 mb-2">ğŸ“Š Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§</h3>
          <canvas id="homeHondaChart" height="200"></canvas>
        </div>
        <div class="bg-white p-4 rounded-xl shadow border">
          <h3 class="font-bold text-indigo-700 mb-2">ğŸ¢ ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØ§ØªØ¨</h3>
          <canvas id="homeOfficeChart" height="200"></canvas>
        </div>
      </div>

      <!-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
      <div class="bg-white p-4 rounded-xl shadow border mt-6">
        <h3 class="font-bold text-gray-700 mb-2">ğŸ‘¨â€ğŸ’¼ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¸ÙŠÙØ©</h3>
        <canvas id="homeJobChart" height="200"></canvas>
      </div>
    
  `;

        loadHomeStats();
      } else if (section === "addEmployee") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-orange-800 mb-4">ğŸ“Œ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h2>
    <form method="POST" action="https://script.google.com/macros/s/AKfycbyIkawBofCnNpqwyk8t1VP3ryipZ-8N3rUeyHfp7khBIHSI8O7b6lVZF9kLtDKY8dY5/exec" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" class="input-style" required />
        <input type="text" name="nationalId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ" class="input-style" />
        <input type="text" name="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="input-style" />
        <input type="text" name="mobile" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="input-style" />
        <input type="text" name="jobTitle" placeholder="Ø§Ù„ÙˆØ¸ÙŠÙØ©" class="input-style" />
        <input type="text" name="project" placeholder="Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" class="input-style" />
        <select name="office" class="input-style">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙƒØªØ¨</option>
          <option value="Ø´Ø¨Ø±Ø§">Ø´Ø¨Ø±Ø§</option>
          <option value="Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³">Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³</option>
          <option value="Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†">Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†</option>
        </select>

        <div class="flex flex-col">
  <select name="status" class="input-style">
    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ø£Ø¹Ø²Ø¨">Ø£Ø¹Ø²Ø¨</option>
    <option value="Ù…ØªØ²ÙˆØ¬">Ù…ØªØ²ÙˆØ¬</option>
    <option value="Ù…Ø·Ù„Ù‚">Ù…Ø·Ù„Ù‚</option>
    <option value="Ø£Ø±Ù…Ù„">Ø£Ø±Ù…Ù„</option>
  </select>
</div>
        <div class="flex flex-col">
  <label class="text-sm text-gray-700 mb-1">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
  <input type="date" name="birthDate" class="input-style" />
</div>

<div class="flex flex-col">
  <label class="text-sm text-gray-700 mb-1">ğŸ—“ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</label>
  <input type="date" name="hireDate" class="input-style" />
</div>

        

        <input type="number" name="salary" placeholder="Ø§Ù„Ù…Ø±ØªØ¨ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" class="input-style" />
      </div>
      <button type="submit" class="bg-orange-600 text-white px-6 py-3 rounded shadow hover:bg-orange-700">
        â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù
      </button>
    </form>
  `;
      } else if (section === "viewEmployees") {
        main.innerHTML = `
    <h2 class="text-2xl font-bold text-teal-800 mb-4">ğŸ‘¨â€ğŸ’¼ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>

<!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« -->
<div class="flex flex-wrap gap-4 items-center bg-teal-50 p-4 rounded shadow mb-4">
  <input type="text" id="searchEmployee" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..." 
         class="px-4 py-2 border border-gray-300 rounded w-full md:w-1/3" 
         oninput="filterEmployees()" />

  <button onclick="fetchEmployeeData()" 
          class="bg-teal-600 text-white px-4 py-2 rounded shadow hover:bg-teal-700 flex items-center gap-2">
    <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
    <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
  </button>

  <button onclick="exportEmployeesToExcel()" 
          class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2">
    <i data-lucide="download" class="w-4 h-4"></i>
    <span>ØªØ­Ù…ÙŠÙ„ Excel</span>
  </button>
  <button onclick="showStatsPopup()"
        class="bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 flex items-center gap-2">
  <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
  <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
</button>

</div>

      <table class="min-w-full bg-white text-center border border-gray-200">
        <thead class="bg-teal-100 text-teal-800 font-bold">
          <tr>
            <th class="px-4 py-2 border">HireDate</th>
            <th class="px-4 py-2 border">Name</th>
            <th class="px-4 py-2 border">NationalId</th>
            <th class="px-4 py-2 border">Address</th>
            <th class="px-4 py-2 border">Mobile</th>
            <th class="px-4 py-2 border">JobTitle</th>
            <th class="px-4 py-2 border">Project</th>
            <th class="px-4 py-2 border">Office</th>
            <th class="px-4 py-2 border">Status</th>
            <th class="px-4 py-2 border">Salary</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody"></tbody>
      </table>
    </div>
  `;
        lucide.createIcons();
        fetchEmployeeData();
      }
    }
    function filterBySiteID() {
      const input = document
        .getElementById("searchSiteID")
        .value.trim()
        .toLowerCase();
      const rows = document.querySelectorAll("#housingTableBody tr");
      rows.forEach((row) => {
        const siteID = row.cells[5]?.textContent.toLowerCase() || "";
        if (siteID.includes(input)) {
          row.style.display = "";
        } else {
          row.style.display = "none";
        }
      });
    }
    function fetchNewAttendance() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");
      overlay.classList.remove("hidden");
      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);
      fetch(
        "https://script.google.com/macros/s/AKfycby5QdbFnpkhnBFkl5el6B2rflE1HcCHTMzV2hERMhbll4veiAESm4ElsQf7Bey3sDzUAQ/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const tableBody = document.getElementById("attendanceTableBody");
          tableBody.innerHTML = "";
          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.className = "text-center hover:bg-gray-100 transition";
            tr.innerHTML = `
          <td class="px-4 py-2 border">${row["Ø§Ù„ÙˆÙ‚Øª"]}</td>
          <td class="px-4 py-2 border">${row["Ø§Ù„Ø§Ø³Ù…"]}</td>
          <td class="px-4 py-2 border">${row["Ø§Ù„Ù…ÙƒØªØ¨"]}</td>
          <td class="px-4 py-2 border font-bold ${row["Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"] === "Ø¯Ø®ÙˆÙ„" ? "text-green-600" : "text-red-600"
              }">${row["Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡"]}</td>
          <td class="px-4 py-2 border">${row["Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ (Latitude)"]}</td>
          <td class="px-4 py-2 border">${row["Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Longitude)"]}</td>
          <td class="px-4 py-2 border"><a href="${row["Ø§Ù„ØµÙˆØ±Ø© (Ø±Ø§Ø¨Ø·)"]
              }" target="_blank" class="text-blue-500 underline">Ø¹Ø±Ø¶</a></td>
        `;
            tableBody.appendChild(tr);
          });
          lucide.createIcons();
        })
        .catch((err) => {
          console.error(err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden");
        });
    }
    function formatCustomDateTimeISO(dateStr, timeStr) {
      try {
        const dateObj = new Date(dateStr);
        const timeObj = new Date(timeStr);

        const final = new Date(
          dateObj.getFullYear(),
          dateObj.getMonth(),
          dateObj.getDate(),
          timeObj.getHours(),
          timeObj.getMinutes()
        );
        return final.toLocaleString("ar-EG", {
          timeZone: "Africa/Cairo",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      } catch (e) {
        return `${dateStr} | ${timeStr}`;
      }
    }
    function fetchHousingData() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");
      overlay.classList.remove("hidden");

      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);
      fetch(
        "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const tableBody = document.getElementById("housingTableBody");
          tableBody.innerHTML = "";

          data.forEach((row) => {
            console.log("ğŸ•“ RAW Date & Time", row["Date"], "|", row["Time "]);

            const tr = document.createElement("tr");
            tr.className = "text-center hover:bg-gray-100 transition";
            tr.innerHTML = `
  <td class="px-4 py-2 border">${formatCustomDateTimeISO(
              row["Date"],
              row["Time "]
            )}</td>
  <td class="px-4 py-2 border">${row["Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ†"] || ""}</td>
  <td class="px-4 py-2 border">${row["Resource Name"] || ""}</td>
  <td class="px-4 py-2 border">${row["Office"] || ""}</td>
  <td class="px-4 py-2 border">${row["PG S.N."] || ""}</td>
  <td class="px-4 py-2 border">${row["Site ID"] || ""}</td>
  <td class="px-4 py-2 border">${row["Category"] || ""}</td>
  <td class="px-4 py-2 border">${row["Fuel spear"] || ""}</td>
`;
            tableBody.appendChild(tr);
          });
        })
        .catch((err) => {
          console.error(err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³ÙƒÙŠÙ†.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden");
        });
    }
    function formatDateTime(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr; // Ù„Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ø´ ØµØ§Ù„Ø­

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø­Ø³Ø¨ ØªÙˆÙ‚ÙŠØª Ù…ØµØ± (GMT+3)
      return date.toLocaleString("ar-EG", {
        timeZone: "Africa/Cairo",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    function filterTable() {
      const searchName =
        document.getElementById("searchName")?.value.trim() || "";
      const searchSiteID =
        document.getElementById("searchSiteID")?.value.trim() || "";
      const fromDate = document.getElementById("fromDate")?.value || "";
      const toDate = document.getElementById("toDate")?.value || "";
      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ³ÙƒÙŠÙ†
      const housingRows = document.querySelectorAll("#housingTableBody tr");
      housingRows.forEach((row) => {
        const name = row.querySelector("td:nth-child(3)")?.textContent || "";
        const siteID =
          row.querySelector("td:nth-child(6)")?.textContent || "";
        const date = row.querySelector("td:nth-child(7)")?.textContent || "";
        let show = true;
        if (searchName && !name.includes(searchName)) show = false;
        if (searchSiteID && !siteID.includes(searchSiteID)) show = false;
        if (fromDate && date < fromDate) show = false;
        if (toDate && date > toDate) show = false;
        row.style.display = show ? "" : "none";
      });
      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±
      const attendanceRows = document.querySelectorAll(
        "#attendanceTableBody tr"
      );
      attendanceRows.forEach((row) => {
        const name = row.querySelector("td:nth-child(2)")?.textContent || "";
        const dateTimeText =
          row.querySelector("td:nth-child(1)")?.textContent || "";
        const dateObj = new Date(dateTimeText.replace(",", ""));
        let show = true;
        if (searchName && !name.includes(searchName)) show = false;
        // ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„
        if (!isNaN(dateObj)) {
          if (fromDate && dateObj < new Date(fromDate)) show = false;
          if (toDate && dateObj > new Date(toDate)) show = false;
        }
        row.style.display = show ? "" : "none";
      });
    }
    function formatDateOnly(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      if (isNaN(date)) return dateStr;
      return date.toLocaleDateString("ar-EG", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });
    }
    function formatTimeOnly(timeStr) {
      if (!timeStr) return "";
      const date = new Date("1970-01-01T" + timeStr);
      if (isNaN(date)) return timeStr;
      return date.toLocaleTimeString("ar-EG", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    function previewImage() {
      const input = document.getElementById("photo");
      const preview = document.getElementById("preview");
      const plusIcon = document.getElementById("plusIcon");
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.src = e.target.result;
          preview.classList.remove("hidden");
          plusIcon.classList.add("hidden");
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    function fetchEmployeeData() {
      const overlay = document.getElementById("loaderOverlay");
      const countdownText = document.getElementById("countdown");

      // âœ… Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      overlay.classList.remove("hidden");

      let seconds = 0;
      countdownText.textContent = seconds;
      const timer = setInterval(() => {
        seconds++;
        countdownText.textContent = seconds;
      }, 1000);

      fetch(
        "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const tableBody = document.getElementById("employeeTableBody");
          tableBody.innerHTML = "";
          data.forEach((emp) => {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-gray-100 transition";
            tr.innerHTML = `
          <td class="px-4 py-2 border">${formatDateOnly(emp.hireDate)}</td>
          <td class="px-4 py-2 border">${emp.name || ""}</td>
          <td class="px-4 py-2 border">${emp.nationalId || ""}</td>
          <td class="px-4 py-2 border">${emp.address || ""}</td>
          <td class="px-4 py-2 border">${emp.mobile || ""}</td>
          <td class="px-4 py-2 border">${emp.jobTitle || ""}</td>
          <td class="px-4 py-2 border">${emp.project || ""}</td>
          <td class="px-4 py-2 border">${emp.office || ""}</td>
          <td class="px-4 py-2 border">${emp.status || ""}</td>
          <td class="px-4 py-2 border">${emp.salary || ""}</td>
        `;
            tableBody.appendChild(tr);
          });
        })
        .catch((err) => {
          console.error(err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.");
        })
        .finally(() => {
          clearInterval(timer);
          overlay.classList.add("hidden"); // âœ… Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        });
    }

    function filterEmployees() {
      const input = document
        .getElementById("searchEmployee")
        .value.trim()
        .toLowerCase();
      const rows = document.querySelectorAll("#employeeTableBody tr");

      rows.forEach((row) => {
        const nameCell = row.querySelector("td:first-child");
        const nameText = nameCell?.textContent.toLowerCase() || "";
        row.style.display = nameText.includes(input) ? "" : "none";
      });
    }

    function exportEmployeesToExcel() {
      const table = document.querySelector("table");
      const rows = Array.from(table.querySelectorAll("tr"));

      let csvContent = "\uFEFF"; // BOM for UTF-8
      rows.forEach((row) => {
        const cells = Array.from(row.querySelectorAll("th, td")).map(
          (cell) => `="${cell.innerText}"`
        );
        csvContent += cells.join(",") + "\n";
      });

      const blob = new Blob([csvContent], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "employees.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showStatsPopup() {
      const popup = document.getElementById("statsPopup");
      popup.classList.remove("hidden");

      fetch(
        "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          const total = data.length;
          const married = data.filter(
            (emp) => emp["status"] === "Ù…ØªØ²ÙˆØ¬"
          ).length;
          const salaries = data
            .map((emp) => parseFloat(emp["salary"]))
            .filter((s) => !isNaN(s));
          const avgSalary = (
            salaries.reduce((a, b) => a + b, 0) / salaries.length
          ).toFixed(2);

          document.getElementById("totalCount").textContent = total;
          document.getElementById("marriedCount").textContent = married;
          document.getElementById("avgSalary").textContent = avgSalary;

          // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ
          const ctx = document.getElementById("statsChart").getContext("2d");
          // ğŸ•’ ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ù…Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„
const today = new Date();
const experienceGroups = { "Ø¬Ø¯ÙŠØ¯": 0, "Ù…ØªÙˆØ³Ø·": 0, "Ø®Ø¨ÙŠØ±": 0 };

data.forEach((emp) => {
  const hireDate = new Date(emp["hireDate"]);
  if (!isNaN(hireDate)) {
    const years = (today - hireDate) / (1000 * 60 * 60 * 24 * 365.25);
    if (years < 1) experienceGroups["Ø¬Ø¯ÙŠØ¯"]++;
    else if (years < 3) experienceGroups["Ù…ØªÙˆØ³Ø·"]++;
    else experienceGroups["Ø®Ø¨ÙŠØ±"]++;
  }
});

// Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø±Ø³Ù… Ø¬Ø¯ÙŠØ¯ ÙˆØªØ­Ù…ÙŠÙ„Ù‡
const expCanvas = document.createElement("canvas");
expCanvas.id = "experienceChart";
document.getElementById("statsContent").appendChild(expCanvas);

new Chart(expCanvas, {
  type: "bar",
  data: {
    labels: Object.keys(experienceGroups),
    datasets: [{
      label: "Ø­Ø³Ø¨ Ù…Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„",
      data: Object.values(experienceGroups),
      backgroundColor: ["#06b6d4", "#4f46e5", "#9333ea"]
    }]
  },
  options: {
    plugins: { legend: { display: false } },
    responsive: true
  }
});

          if (window.statsChartInstance) window.statsChartInstance.destroy(); // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…
          window.statsChartInstance = new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Ù…ØªØ²ÙˆØ¬", "Ø£Ø¹Ø²Ø¨"],
              datasets: [
                {
                  data: [married, total - married],
                  backgroundColor: ["#6366F1", "#E5E7EB"],
                },
              ],
            },
            options: {
              plugins: { legend: { position: "bottom" } },
            },
          });
        });
    }

    function hideStatsPopup() {
      document.getElementById("statsPopup").classList.add("hidden");
    }

    function downloadStatsPDF() {
      const statsElement = document.getElementById("statsContent");

      html2canvas(statsElement).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 15, 15, 180, 160);
        pdf.save("employee-stats.pdf");
      });
    }

    function showHousingStats() {
      const popup = document.getElementById("housingStatsPopup");
      popup.classList.remove("hidden");

      fetch(
        "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
      )
        .then((res) => res.json())
        .then((data) => {
          // Ù†Ø³Ø¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØªØ¨
          const officeCount = {};
          const hondaCount = {};
          const usageTimes = {};

          data.forEach((row) => {
            const office = row["Office"]?.trim();
            const honda = row["PG S.N."]?.trim();
            const type = row["Ù†ÙˆØ¹ Ø§Ù„ØªØ³ÙƒÙŠÙ†"]?.trim();
            const dateTimeStr = row["Date"] + "T" + (row["Time "] || "00:00");

            // Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù…ÙƒØ§ØªØ¨
            if (office) officeCount[office] = (officeCount[office] || 0) + 1;

            // Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§
            if (honda) hondaCount[honda] = (hondaCount[honda] || 0) + 1;

            // Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§ (Ø¨ÙŠÙ† Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ©)
            if (honda && type) {
              if (!usageTimes[honda]) usageTimes[honda] = [];
              usageTimes[honda].push({ type, time: new Date(dateTimeStr) });
            }
          });

          const totalOffices = Object.values(officeCount).reduce(
            (a, b) => a + b,
            0
          );
          const totalHondas = Object.values(hondaCount).reduce(
            (a, b) => a + b,
            0
          );

          const officeLabels = Object.keys(officeCount);
          const officeData = officeLabels.map((key) =>
            ((officeCount[key] / totalOffices) * 100).toFixed(1)
          );

          const hondaLabels = Object.keys(hondaCount);
          const hondaData = hondaLabels.map((key) =>
            ((hondaCount[key] / totalHondas) * 100).toFixed(1)
          );

          const officeCtx = document
            .getElementById("officeChart")
            .getContext("2d");
          const hondaCtx = document
            .getElementById("hondaChart")
            .getContext("2d");

          if (window.officeChartInstance)
            window.officeChartInstance.destroy();
          if (window.hondaChartInstance) window.hondaChartInstance.destroy();

          window.officeChartInstance = new Chart(officeCtx, {
            type: "bar",
            data: {
              labels: officeLabels,
              datasets: [
                {
                  label: "Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³ÙƒÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ÙƒØªØ¨",
                  data: officeData,
                  backgroundColor: "#4F46E5",
                },
              ],
            },
            options: { indexAxis: "y", responsive: true },
          });

          window.hondaChartInstance = new Chart(hondaCtx, {
            type: "bar",
            data: {
              labels: hondaLabels,
              datasets: [
                {
                  label: "Ù†Ø³Ø¨Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§",
                  data: hondaData,
                  backgroundColor: "#10B981",
                },
              ],
            },
            options: { indexAxis: "y", responsive: true },
          });

          // â— ÙƒØ´Ù Ø§Ù„ØªØ³ÙƒÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„
const incompleteList = [];

for (const honda in usageTimes) {
  const events = usageTimes[honda].sort((a, b) => a.time - b.time);

  for (let i = 0; i < events.length; i++) {
    const current = events[i];
    const next = events[i + 1];

    if (current.type === "Ø¨Ø¯Ø§ÙŠØ©") {
      if (!next || next.type !== "Ù†Ù‡Ø§ÙŠØ©" || (next.time - current.time) > 24 * 3600 * 1000) {
        incompleteList.push({
          honda,
          time: current.time.toLocaleString("ar-EG"),
        });
      }
    }
  }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØ³ÙƒÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„
if (incompleteList.length > 0) {
  const table = document.createElement("table");
  table.className = "w-full mt-6 border border-red-400 text-red-700 bg-red-50 text-sm rounded overflow-hidden";
  table.innerHTML = `
    <thead class="bg-red-100">
      <tr><th class="px-2 py-1 border">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§</th><th class="px-2 py-1 border">ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th></tr>
    </thead>
    <tbody>
      ${incompleteList.map(i => `
        <tr>
          <td class="px-2 py-1 border">${i.honda}</td>
          <td class="px-2 py-1 border">${i.time}</td>
        </tr>
      `).join("")}
    </tbody>
  `;
  document.getElementById("housingStatsContent").appendChild(table);
}


          // Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‡ÙˆÙ†Ø¯Ø§
          let totalHours = 0;
          for (const honda in usageTimes) {
            const events = usageTimes[honda].sort((a, b) => a.time - b.time);
            for (let i = 0; i < events.length - 1; i++) {
              if (
                events[i].type === "Ø¨Ø¯Ø§ÙŠØ©" &&
                events[i + 1].type === "Ù†Ù‡Ø§ÙŠØ©"
              ) {
                const diff =
                  (events[i + 1].time - events[i].time) / 1000 / 3600;
                if (diff > 0 && diff < 24) totalHours += diff;
              }
            }
          }
          document.getElementById("totalHondaHours").textContent =
            totalHours.toFixed(1);
        });
    }

    function hideHousingStats() {
      document.getElementById("housingStatsPopup").classList.add("hidden");
    }

    function downloadHousingStatsPDF() {
      const statsElement = document.getElementById("housingStatsContent");
      html2canvas(statsElement).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 15, 15, 180, 160);
        pdf.save("housing-stats.pdf");
      });
    }

    function loadHomeStats() {
      Promise.all([
        fetch(
          "https://script.google.com/macros/s/AKfycbwW05ThHhLzFFqq3mZ-hvayRoHlGA7ESpd0ysT1lVPY3nukqr6S5f1WdyHWobGF3c5p/exec"
        ).then((res) => res.json()),
        fetch(
          "https://script.google.com/macros/s/AKfycbxoeOxRbxrbvYiqS_gtvYJuPMDasV3rbFyg-GyZhR5Scdj30OGhU6wq1jDtfMnWV9G7ig/exec"
        ).then((res) => res.json()),
      ]).then(([employees, housing]) => {
        // âœ… Ø§Ù„ÙƒØ±ÙˆØª
        document.getElementById("employeeCount").textContent =
          employees.length;
        document.getElementById("housingCount").textContent = housing.length;
        document.getElementById("lastUpdate").textContent =
          new Date().toLocaleString("ar-EG");

        const targetOffices = ["Ø´Ø¨Ø±Ø§", "Ø¬Ø³Ø± Ø§Ù„Ø³ÙˆÙŠØ³", "Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†"];
        const officeList = document.getElementById("officeList");

        officeList.innerHTML = targetOffices
          .map((office) => {
            const count = employees.filter(
              (emp) => emp["office"] === office
            ).length;
            return `<li>â€¢ ${office}: ${count} Ù…ÙˆØ¸Ù</li>`;
          })
          .join("");

        // âœ… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù‡ÙˆÙ†Ø¯Ø§
        const hondaCount = {};
        housing.forEach((row) => {
          const honda = row["PG S.N."]?.trim();
          if (honda) hondaCount[honda] = (hondaCount[honda] || 0) + 1;
        });
        const hondaLabels = Object.keys(hondaCount);
        const hondaData = Object.values(hondaCount);

        new Chart(document.getElementById("homeHondaChart"), {
          type: "bar",
          data: {
            labels: hondaLabels,
            datasets: [
              {
                label: "Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…",
                data: hondaData,
                backgroundColor: "#14b8a6",
              },
            ],
          },
          options: { responsive: true, indexAxis: "y" },
        });

        // âœ… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…ÙƒØ§ØªØ¨
        const officeCount = {};
        housing.forEach((row) => {
          const office = row["Office"]?.trim();
          if (office) officeCount[office] = (officeCount[office] || 0) + 1;
        });
        const officeLabels = Object.keys(officeCount);
        const officeData = Object.values(officeCount);

        new Chart(document.getElementById("homeOfficeChart"), {
          type: "pie",
          data: {
            labels: officeLabels,
            datasets: [
              {
                data: officeData,
                backgroundColor: officeLabels.map(
                  () => `hsl(${Math.random() * 360}, 70%, 70%)`
                ),
              },
            ],
          },
        });

        // âœ… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„ÙˆØ¸Ø§Ø¦Ù
        const jobCount = {};
        employees.forEach((emp) => {
          const job = emp["jobTitle"]?.trim();
          if (job) jobCount[job] = (jobCount[job] || 0) + 1;
        });
        const jobLabels = Object.keys(jobCount);
        const jobData = Object.values(jobCount);

        new Chart(document.getElementById("homeJobChart"), {
          type: "bar",
          data: {
            labels: jobLabels,
            datasets: [
              {
                label: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                data: jobData,
                backgroundColor: "#6366f1",
              },
            ],
          },
          options: { responsive: true },
        });
      });
    }
  </script>
</body>

</html>
